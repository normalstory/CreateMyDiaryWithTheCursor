<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>편편상회 관리자</title>
    <!-- Tailwind CSS - 프로덕션에서는 빌드된 CSS 파일 사용 권장 -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- CKEditor 추가 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
    <!-- 이미지 최적화를 위한 browser-image-compression 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2C3E50',
                        beige: '#F5F0E1',
                        brown: '#D7A86E',
                        yellow: '#F1C40F'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">
    <!-- 로그인 모달 -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg w-96">
            <h2 class="text-2xl font-bold mb-6">관리자 로그인</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">아이디</label>
                    <input type="text" id="adminId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">비밀번호</label>
                    <input type="password" id="adminPw" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90">
                    로그인
                </button>
            </form>
        </div>
    </div>

    <!-- 메인 대시보드 -->
    <div id="dashboard" class="hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-secondary">편편상회 관리자</span>
                    </div>
                    <div class="flex items-center">
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-900">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 통계 대시보드 -->
            <div class="grid grid-cols-3 gap-2 sm:gap-4 md:gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">금일 문의</h3>
                    <p id="todayInquiries" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">이번 달 문의</h3>
                    <p id="monthInquiries" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">계약 완료</h3>
                    <p id="completedContracts" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
            </div>

            <!-- 파트너 문의 관리 -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">파트너 문의 관리</h2>
                    <div class="flex space-x-2">
                        <select id="statusFilter" class="border rounded-md px-3 py-1">
                            <option value="all">전체</option>
                            <option value="pending">접수완료</option>
                            <option value="checking">확인중</option>
                            <option value="consulting">상담중</option>
                            <option value="completed">상담완료</option>
                            <option value="canceled">취소</option>
                        </select>
                        <button onclick="inquiryManager.loadInquiries()" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200">
                            <i class="ri-refresh-line"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">상태</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">이름</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">희망지역</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">파트너 유형</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">관리</th>
                            </tr>
                        </thead>
                        <tbody id="inquiryList" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 활동 로그 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">활동 로그</h2>
                    <button id="toggleActivityLogs" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 flex items-center gap-2">
                        <span>펼치기</span>
                        <i class="ri-arrow-down-s-line"></i>
                    </button>
                </div>
                <div id="activityLogsContent" class="hidden">
                    <!-- 로딩 상태 표시 -->
                    <div id="activityLoading" class="hidden flex items-center justify-center py-8">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                            <span class="text-gray-600">조회중...</span>
                        </div>
                    </div>
                    
                    <!-- 데이터 테이블 -->
                    <div id="activityTable" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">시간</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">관리자</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">신청자</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">작업</th>
                                </tr>
                            </thead>
                            <tbody id="activityList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <!-- 페이지네이션 -->
                    <div id="activityPagination" class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            <span id="activityPageInfo">0-0 / 0개</span>
                        </div>
                        <div class="flex gap-2">
                            <button id="prevActivityPage" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                이전
                            </button>
                            <button id="nextActivityPage" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                다음
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메시지 전송 모달 수정 -->
    <div id="messageModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-[800px] max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium">메시지 작성</h3>
                <button onclick="messageManager.closeMessageModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="messageEditor"></div>
            </div>
            <div class="p-4 border-t flex justify-end gap-2">
                <button onclick="messageManager.closeMessageModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    취소
                </button>
                <button onclick="messageManager.sendMessage()" 
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                    전송
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCbu_1gbtSIVUvmmw5RyLYvjaYOG7RdCWw",
            authDomain: "ppap-ea44a.firebaseapp.com",
            projectId: "ppap-ea44a",
            storageBucket: "ppap-ea44a.firebasestorage.app",
            messagingSenderId: "811949338329",
            appId: "1:811949338329:web:cda8d43a7aeb825ce258c8",
            measurementId: "G-6QGZT6Y1TE"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase Authentication 관련 에러 무시 (현재 사용하지 않음)
        // Authentication이 설정되지 않아도 Firestore는 정상 작동

        // Firebase 컬렉션 초기화 함수
        const initializeCollections = async () => {
            try {
                // franchise_inquiries 컬렉션이 없으면 생성
                const inquiriesSnapshot = await db.collection('franchise_inquiries').get();
                if (inquiriesSnapshot.empty) {
                    // 샘플 데이터 추가
                    await db.collection('franchise_inquiries').add({
                        name: '홍길동',
                        phone: '010-1234-5678',
                        location: '서울 강남구',
                        partnerType: '전속 파트너',
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // activity_logs 컬렉션이 없으면 생성
                const logsSnapshot = await db.collection('activity_logs').get();
                if (logsSnapshot.empty) {
                    // 샘플 로그 추가
                    await db.collection('activity_logs').add({
                        action: 'system_init',
                        data: { message: '시스템 초기화' },
                        adminId: 'system',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                console.log('Firebase 컬렉션 초기화 완료');
            } catch (error) {
                console.error('Firebase 컬렉션 초기화 실패:', error);
                
                // 권한 에러인 경우 사용자에게 안내
                if (error.code === 'permission-denied') {
                    alert('Firebase 권한 설정이 필요합니다.\n\nFirebase Console에서 Firestore 보안 규칙을 확인해주세요.\n\n임시 해결책:\nrules_version = \'2\';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}');
                }
            }
        };

        // 통계 관리자
        const statsManager = {
            async updateStatistics() {
                try {
                    // 오늘 날짜 설정 (시작 시간)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // 이번 달 시작일 설정
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

                    // 금일 문의 수 조회
                    const todayInquiries = await db.collection('franchise_inquiries')
                        .where('createdAt', '>=', today)
                        .get();

                    // 이번 달 문의 수 조회
                    const monthInquiries = await db.collection('franchise_inquiries')
                        .where('createdAt', '>=', monthStart)
                        .get();

                    // 계약 완료 수 조회
                    const completedInquiries = await db.collection('franchise_inquiries')
                        .where('status', '==', 'completed')
                        .get();

                    // 통계 업데이트
                    document.getElementById('todayInquiries').textContent = todayInquiries.size;
                    document.getElementById('monthInquiries').textContent = monthInquiries.size;
                    document.getElementById('completedContracts').textContent = completedInquiries.size;
                } catch (error) {
                    console.error('통계 업데이트 실패:', error);
                }
            }
        };

        // 활동 로그 관리자
        const activityLogger = {
            currentPage: 1,
            pageSize: 10,
            totalLogs: 0,
            isExpanded: false,
            allLogs: [],

            showLoading() {
                document.getElementById('activityLoading').classList.remove('hidden');
                document.getElementById('activityTable').classList.add('hidden');
                document.getElementById('activityPagination').classList.add('hidden');
            },

            hideLoading() {
                document.getElementById('activityLoading').classList.add('hidden');
                document.getElementById('activityTable').classList.remove('hidden');
                document.getElementById('activityPagination').classList.remove('hidden');
            },

            async logActivity(action, data) {
                try {
                    await db.collection('activity_logs').add({
                        action,
                        data,
                        adminId: localStorage.getItem('adminId'),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('활동 로그 기록 실패:', error);
                    // 권한 에러는 조용히 무시 (사용자 경험 개선)
                    if (error.code !== 'permission-denied') {
                        console.warn('활동 로그 기록에 실패했습니다:', error.message);
                    }
                }
            },

            async loadActivityLogs(page = 1) {
                try {
                    this.showLoading();
                    this.currentPage = page;
                    
                    // 모든 로그를 한 번에 가져오기 (최대 100개)
                    const snapshot = await db.collection('activity_logs')
                        .orderBy('timestamp', 'desc')
                        .limit(100)
                        .get();

                    this.allLogs = [];
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        let applicantName = '-';

                        // 문의 ID가 있는 경우 신청자 정보 조회
                        if (data.data && data.data.inquiryId) {
                            try {
                                const inquiryDoc = await db.collection('franchise_inquiries')
                                    .doc(data.data.inquiryId)
                                    .get();
                                
                                if (inquiryDoc.exists) {
                                    applicantName = inquiryDoc.data().name || '-';
                                }
                            } catch (error) {
                                console.error('신청자 정보 조회 실패:', error);
                            }
                        }

                        this.allLogs.push({
                            id: doc.id,
                            ...data,
                            applicantName
                        });
                    }

                    this.totalLogs = this.allLogs.length;
                    this.displayCurrentPage();
                    this.hideLoading();
                } catch (error) {
                    console.error('활동 로그 로드 실패:', error);
                    this.hideLoading();
                    
                    // 권한 에러인 경우 사용자에게 안내
                    if (error.code === 'permission-denied') {
                        const tbody = document.getElementById('activityList');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                    <div class="mb-4">
                                        <i class="ri-error-warning-line text-4xl text-yellow-500"></i>
                                    </div>
                                    <div class="text-lg font-medium mb-2">Firebase 권한 설정이 필요합니다</div>
                                    <div class="text-sm text-gray-400">
                                        Firebase Console에서 Firestore 보안 규칙을 확인해주세요.
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                }
            },

            displayCurrentPage() {
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const pageLogs = this.allLogs.slice(startIndex, endIndex);

                const tbody = document.getElementById('activityList');
                tbody.innerHTML = '';

                pageLogs.forEach(log => {
                    const row = `
                        <tr>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">
                                ${new Date(log.timestamp.toDate()).toLocaleString()}
                            </td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${log.adminId}</td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${log.applicantName}</td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${this.getActionText(log.action)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // 페이지네이션 정보 업데이트
                this.updatePaginationInfo();
            },

            updatePaginationInfo() {
                const startIndex = (this.currentPage - 1) * this.pageSize + 1;
                const endIndex = Math.min(this.currentPage * this.pageSize, this.totalLogs);
                
                document.getElementById('activityPageInfo').textContent = 
                    `${startIndex}-${endIndex} / ${this.totalLogs}개`;

                // 이전/다음 버튼 활성화/비활성화
                const prevBtn = document.getElementById('prevActivityPage');
                const nextBtn = document.getElementById('nextActivityPage');
                
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage * this.pageSize >= this.totalLogs;
            },

            async nextPage() {
                if (this.currentPage * this.pageSize < this.totalLogs) {
                    this.currentPage++;
                    this.displayCurrentPage();
                }
            },

            async prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.displayCurrentPage();
                }
            },

            async expandAndLoad() {
                if (!this.isExpanded) {
                    this.isExpanded = true;
                    await this.loadActivityLogs(1);
                }
            },

            getActionText(action) {
                const actionTexts = {
                    'login': '로그인',
                    'logout': '로그아웃',
                    'update_inquiry_status': '문의 상태 변경',
                    'update_inquiry_memo': '상담 메모 작성',
                    'view_inquiry_detail': '문의 상세 조회',
                    'delete_inquiry': '문의 삭제',
                    'send_message': '메시지 전송',
                    'system_init': '시스템 초기화'
                };
                return actionTexts[action] || action;
            }
        };

        // 이미지 관리자 수정
        const imageManager = {
            // 이미지 최적화
            async optimizeImage(file) {
                try {
                    const options = {
                        maxSizeMB: 0.5,
                        maxWidthOrHeight: 1200,
                        useWebWorker: true,
                        fileType: 'image/jpeg',
                        initialQuality: 0.7
                    };
                    
                    const compressedFile = await imageCompression(file, options);
                    console.log('압축 전 크기:', file.size / 1024 / 1024, 'MB');
                    console.log('압축 후 크기:', compressedFile.size / 1024 / 1024, 'MB');
                    return compressedFile;
                } catch (error) {
                    console.error('이미지 최적화 실패:', error);
                    throw new Error('이미지 최적화에 실패했습니다.');
                }
            },

            // 이미지를 Base64로 변환
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('파일 읽기 실패'));
                    reader.readAsDataURL(file);
                });
            },

            // Firestore에 이미지 업로드
            async uploadToFirestore(file) {
                try {
                    const optimizedFile = await this.optimizeImage(file);
                    const base64Data = await this.fileToBase64(optimizedFile);
                    
                    // Firestore에 이미지 데이터 저장
                    const docRef = await db.collection('inquiry_images').add({
                        data: base64Data,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        type: optimizedFile.type,
                        size: optimizedFile.size
                    });

                    // 이미지 URL 생성 (Base64 데이터 직접 사용)
                    return base64Data;
                } catch (error) {
                    console.error('Firestore 업로드 실패:', error);
                    throw new Error('이미지 업로드에 실패했습니다.');
                }
            }
        };

        // 메시지 관리자 수정
        const messageManager = {
            currentInquiryId: null,
            editor: null,

            initEditor() {
                if (!this.editor) {
                    ClassicEditor
                        .create(document.querySelector('#messageEditor'), {
                            toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'uploadImage', '|', 'undo', 'redo'],
                            placeholder: '메시지를 입력하세요...',
                            image: {
                                upload: {
                                    types: ['jpeg', 'png', 'gif', 'bmp', 'webp', 'tiff']
                                }
                            }
                        })
                        .then(editor => {
                            this.editor = editor;

                            // 이미지 업로드 핸들러 수정
                            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                                return {
                                    upload: async () => {
                                        try {
                                            const file = await loader.file;
                                            
                                            if (file.size > 5 * 1024 * 1024) {
                                                throw new Error('파일 크기가 너무 큽니다. 5MB 이하의 이미지를 선택해주세요.');
                                            }

                                            if (!file.type.startsWith('image/')) {
                                                throw new Error('이미지 파일만 업로드 가능합니다.');
                                            }

                                            const url = await imageManager.uploadToFirestore(file);
                                            return { default: url };
                                        } catch (error) {
                                            console.error('이미지 업로드 실패:', error);
                                            throw error;
                                        }
                                    }
                                };
                            };
                        })
                        .catch(error => {
                            console.error('에디터 초기화 실패:', error);
                            alert('에디터 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
                        });
                }
            },

            showMessageModal(inquiryId) {
                this.currentInquiryId = inquiryId;
                document.getElementById('messageModal').classList.remove('hidden');
                this.initEditor();
            },

            closeMessageModal() {
                document.getElementById('messageModal').classList.add('hidden');
                this.currentInquiryId = null;
                if (this.editor) {
                    this.editor.setData('');
                }
            },

            async sendMessage() {
                if (!this.currentInquiryId || !this.editor) return;

                try {
                    const content = this.editor.getData();
                    if (!content.trim()) {
                        alert('메시지 내용을 입력해주세요.');
                        return;
                    }

                    await db.collection('inquiry_messages').add({
                        inquiryId: this.currentInquiryId,
                        content: content,
                        adminId: localStorage.getItem('adminId'),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 활동 로그 기록
                    await activityLogger.logActivity('send_message', {
                        inquiryId: this.currentInquiryId,
                        adminId: localStorage.getItem('adminId')
                    });

                    alert('메시지가 전송되었습니다.');
                    this.closeMessageModal();
                } catch (error) {
                    console.error('메시지 전송 실패:', error);
                    alert('메시지 전송에 실패했습니다.');
                }
            }
        };

        // 문의 관리자
        const inquiryManager = {
            getStatusColor(status) {
                const colors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'checking': 'bg-blue-100 text-blue-800',
                    'consulting': 'bg-purple-100 text-purple-800',
                    'completed': 'bg-green-100 text-green-800',
                    'canceled': 'bg-red-100 text-red-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            },

            async loadInquiries() {
                try {
                    let query = db.collection('franchise_inquiries')
                        .orderBy('createdAt', 'desc');
                    
                    const statusFilter = document.getElementById('statusFilter').value;
                    if (statusFilter !== 'all') {
                        query = query.where('status', '==', statusFilter);
                    }

                    const snapshot = await query.get();
                    const tbody = document.getElementById('inquiryList');
                    tbody.innerHTML = '';

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const statusTexts = {
                            'pending': '접수완료',
                            'checking': '확인중',
                            'consulting': '상담중',
                            'completed': '상담완료',
                            'canceled': '취소'
                        };
                        const row = `
                            <tr>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 rounded text-xs sm:text-sm ${this.getStatusColor(data.status)}">${statusTexts[data.status]}</span>
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">
                                    ${new Date(data.createdAt.toDate()).toLocaleString()}
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base font-medium">${data.name}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.phone}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.location}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.partnerType}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                    <div class="flex space-x-1 sm:space-x-2">
                                        <button onclick="inquiryManager.showDetail('${doc.id}')" 
                                                class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">
                                            상세
                                        </button>
                                        ${data.status === 'consulting' ? `
                                        <button onclick="messageManager.showMessageModal('${doc.id}')"
                                                class="text-green-600 hover:text-green-800 text-sm sm:text-base">
                                            회신
                                        </button>
                                        ` : ''}
                                        <button onclick="inquiryManager.deleteInquiry('${doc.id}')"
                                                class="text-red-600 hover:text-red-800 text-sm sm:text-base">
                                            삭제
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                    await statsManager.updateStatistics();
                } catch (error) {
                    console.error('문의 목록 로드 실패:', error);
                    
                    // 권한 에러인 경우 사용자에게 안내
                    if (error.code === 'permission-denied') {
                        const tbody = document.getElementById('inquiryList');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <div class="mb-4">
                                        <i class="ri-error-warning-line text-4xl text-yellow-500"></i>
                                    </div>
                                    <div class="text-lg font-medium mb-2">Firebase 권한 설정이 필요합니다</div>
                                    <div class="text-sm text-gray-400 mb-4">
                                        Firebase Console에서 Firestore 보안 규칙을 확인해주세요.
                                    </div>
                                    <div class="bg-gray-100 p-3 rounded text-xs font-mono text-left">
                                        rules_version = '2';<br>
                                        service cloud.firestore {<br>
                                        &nbsp;&nbsp;match /databases/{database}/documents {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;match /{document=**} {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if true;<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                                        &nbsp;&nbsp;}<br>
                                        }
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        alert('문의 목록을 불러오는데 실패했습니다.');
                    }
                }
            },

            async showDetail(docId) {
                try {
                    const doc = await db.collection('franchise_inquiries').doc(docId).get();
                    if (!doc.exists) {
                        alert('문의 정보를 찾을 수 없습니다.');
                        return;
                    }

                    const data = doc.data();
                    const statusTexts = {
                        'pending': '접수완료',
                        'checking': '확인중',
                        'consulting': '상담중',
                        'completed': '상담완료',
                        'canceled': '취소'
                    };

                    // 상세 정보 모달 생성
                    const modalHTML = `
                        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-white rounded-lg w-[800px] max-h-[90vh] flex flex-col">
                                <div class="p-4 border-b flex justify-between items-center">
                                    <h3 class="text-lg font-medium">문의 상세 정보</h3>
                                    <button onclick="inquiryManager.closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                                        <i class="ri-close-line text-xl"></i>
                                    </button>
                                </div>
                                <div class="p-6 flex-1 overflow-y-auto">
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">신청자 정보</label>
                                            <div class="space-y-3">
                                                <div>
                                                    <span class="text-sm text-gray-500">이름:</span>
                                                    <span class="ml-2 font-medium">${data.name}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">연락처:</span>
                                                    <span class="ml-2 font-medium">${data.phone}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">희망지역:</span>
                                                    <span class="ml-2 font-medium">${data.location}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">파트너 유형:</span>
                                                    <span class="ml-2 font-medium">${data.partnerType}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">상태 관리</label>
                                            <div class="space-y-3">
                                                <div>
                                                    <span class="text-sm text-gray-500">현재 상태:</span>
                                                    <span class="ml-2 px-2 py-1 rounded text-xs ${this.getStatusColor(data.status)}">${statusTexts[data.status]}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">신청일:</span>
                                                    <span class="ml-2 text-sm">${new Date(data.createdAt.toDate()).toLocaleString()}</span>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">상태 변경</label>
                                                    <select id="statusSelect" class="w-full border rounded-md px-3 py-2">
                                                        <option value="pending" ${data.status === 'pending' ? 'selected' : ''}>접수완료</option>
                                                        <option value="checking" ${data.status === 'checking' ? 'selected' : ''}>확인중</option>
                                                        <option value="consulting" ${data.status === 'consulting' ? 'selected' : ''}>상담중</option>
                                                        <option value="completed" ${data.status === 'completed' ? 'selected' : ''}>상담완료</option>
                                                        <option value="canceled" ${data.status === 'canceled' ? 'selected' : ''}>취소</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ${data.additionalMessage ? `
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">추가 문의 사항</label>
                                        <div class="bg-gray-50 p-4 rounded-md">
                                            <p class="text-sm whitespace-pre-wrap">${data.additionalMessage}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    ${data.imageUrls && data.imageUrls.length > 0 ? `
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            첨부된 이미지 (${data.imageUrls.length}/3개)
                                            <span class="text-xs text-gray-500 ml-2">📸 최적화됨 (높이 300px 기준)</span>
                                        </label>
                                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3" id="admin-image-thumbnails">
                                            <!-- 썸네일은 JS에서 동적으로 생성 -->
                                        </div>
                                        <div class="mt-2 text-xs text-gray-500">
                                            💡 가이드라인: 매장 전경 • 상품 구성 • 참고사항
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="p-4 border-t flex justify-end gap-2">
                                    <button onclick="inquiryManager.closeDetailModal()" 
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        닫기
                                    </button>
                                    <button onclick="inquiryManager.updateStatusFromDetail('${docId}')" 
                                            class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                                        상태 변경
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // 기존 모달 제거 후 새 모달 추가
                    const existingModal = document.getElementById('detailModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    // 모달을 DOM에 추가한 직후 썸네일 동적 생성 코드 추가
                    const container = document.getElementById('admin-image-thumbnails');
                    if (container && Array.isArray(data.imageUrls)) {
                        container.innerHTML = '';
                        data.imageUrls.forEach((url, index) => {
                            const div = document.createElement('div');
                            div.className = 'relative group';
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = `첨부 이미지 ${index + 1}`;
                            img.className = 'w-full h-24 object-cover rounded-lg border cursor-pointer hover:opacity-80 transition-opacity';
                            img.addEventListener('click', function() {
                                window.openImageModal(url, `${data.name}님의 첨부 이미지 ${index + 1}`);
                            });
                            div.appendChild(img);
                            container.appendChild(div);
                        });
                    }

                    // 활동 로그 기록
                    await activityLogger.logActivity('view_inquiry_detail', {
                        inquiryId: docId
                    });

                } catch (error) {
                    console.error('문의 상세 조회 실패:', error);
                    alert('문의 상세 정보를 불러오는데 실패했습니다.');
                }
            },

            closeDetailModal() {
                const modal = document.getElementById('detailModal');
                if (modal) {
                    modal.remove();
                }
            },

            async updateStatusFromDetail(docId) {
                try {
                    const newStatus = document.getElementById('statusSelect').value;
                    
                    // 상담완료로 변경하는 경우 확인 얼럿 표시
                    if (newStatus === 'completed') {
                        const confirmMessage = `상담완료로 상태를 변경하시겠습니까?\n\n⚠️ 주의사항:\n• 첨부된 이미지 파일들이 자동으로 삭제됩니다\n• 삭제된 이미지는 복구할 수 없습니다\n• 상담 완료 후에는 이미지를 다시 확인할 수 없습니다\n\n계속하시겠습니까?`;
                        
                        if (!confirm(confirmMessage)) {
                            return; // 사용자가 취소한 경우
                        }
                    }
                    
                    await this.updateStatus(docId, newStatus);
                    this.closeDetailModal();
                } catch (error) {
                    console.error('상태 업데이트 실패:', error);
                    alert('상태 업데이트에 실패했습니다.');
                }
            },

            async updateStatus(docId, newStatus) {
                try {
                    // 상담 완료 시 이미지 삭제 처리
                    if (newStatus === 'completed') {
                        try {
                            // 문의 데이터 조회
                            const inquiryDoc = await db.collection('franchise_inquiries').doc(docId).get();
                            if (inquiryDoc.exists) {
                                const inquiryData = inquiryDoc.data();
                                
                                // 이미지 URL이 있는 경우 삭제
                                if (inquiryData.imageUrls && inquiryData.imageUrls.length > 0) {
                                    console.log(`상담 완료: ${inquiryData.imageUrls.length}개 이미지 삭제 시작`);
                                    
                                    // Firebase Storage에서 이미지 삭제
                                    const deletePromises = inquiryData.imageUrls.map(async (imageUrl) => {
                                        try {
                                            // URL에서 파일 경로 추출
                                            const urlParts = imageUrl.split('/');
                                            const fileName = urlParts[urlParts.length - 1].split('?')[0];
                                            
                                            // 날짜별 폴더 구조에서 파일 찾기
                                            const dateStr = inquiryData.createdAt.toDate().toISOString().split('T')[0];
                                            const filePath = `franchise_inquiries/${dateStr}/${fileName}`;
                                            
                                            const fileRef = storage.ref().child(filePath);
                                            await fileRef.delete();
                                            
                                            console.log(`이미지 삭제 완료: ${filePath}`);
                                            return { success: true, path: filePath };
                                        } catch (deleteError) {
                                            console.error(`이미지 삭제 실패: ${imageUrl}`, deleteError);
                                            return { success: false, path: imageUrl, error: deleteError };
                                        }
                                    });
                                    
                                    const deleteResults = await Promise.all(deletePromises);
                                    const successCount = deleteResults.filter(result => result.success).length;
                                    const failCount = deleteResults.filter(result => !result.success).length;
                                    
                                    console.log(`이미지 삭제 결과: 성공 ${successCount}개, 실패 ${failCount}개`);
                                    
                                    // 삭제 결과를 활동 로그에 기록
                                    await activityLogger.logActivity('delete_images_on_completion', {
                                        inquiryId: docId,
                                        totalImages: inquiryData.imageUrls.length,
                                        deletedCount: successCount,
                                        failedCount: failCount,
                                        failedUrls: deleteResults.filter(result => !result.success).map(result => result.path)
                                    });
                                    
                                    if (failCount > 0) {
                                        console.warn(`${failCount}개 이미지 삭제에 실패했습니다.`);
                                    }
                                }
                            }
                        } catch (imageDeleteError) {
                            console.error('이미지 삭제 중 오류 발생:', imageDeleteError);
                            // 이미지 삭제 실패해도 상태 업데이트는 계속 진행
                        }
                    }

                    // 상태 업데이트
                    await db.collection('franchise_inquiries').doc(docId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 활동 로그 기록
                    await activityLogger.logActivity('update_inquiry_status', {
                        inquiryId: docId,
                        newStatus: newStatus
                    });

                    // 목록 새로고침
                    await this.loadInquiries();
                    
                    // 상담 완료 시 사용자에게 알림
                    if (newStatus === 'completed') {
                        alert('상담이 완료되었습니다.\n첨부된 이미지 파일들이 자동으로 삭제되었습니다.');
                    }
                } catch (error) {
                    console.error('상태 업데이트 실패:', error);
                    alert('상태 업데이트에 실패했습니다.');
                }
            },

            async deleteInquiry(docId) {
                if (!confirm('정말 삭제하시겠습니까?\n첨부된 이미지 파일들도 함께 삭제됩니다.')) {
                    return;
                }

                try {
                    // 문의 데이터 조회 (이미지 삭제를 위해)
                    const inquiryDoc = await db.collection('franchise_inquiries').doc(docId).get();
                    let imageDeleteResults = [];
                    
                    if (inquiryDoc.exists) {
                        const inquiryData = inquiryDoc.data();
                        
                        // 이미지 URL이 있는 경우 삭제
                        if (inquiryData.imageUrls && inquiryData.imageUrls.length > 0) {
                            console.log(`문의 삭제: ${inquiryData.imageUrls.length}개 이미지 삭제 시작`);
                            
                            // Firebase Storage에서 이미지 삭제
                            const deletePromises = inquiryData.imageUrls.map(async (imageUrl) => {
                                try {
                                    // URL에서 파일 경로 추출
                                    const urlParts = imageUrl.split('/');
                                    const fileName = urlParts[urlParts.length - 1].split('?')[0];
                                    
                                    // 날짜별 폴더 구조에서 파일 찾기
                                    const dateStr = inquiryData.createdAt.toDate().toISOString().split('T')[0];
                                    const filePath = `franchise_inquiries/${dateStr}/${fileName}`;
                                    
                                    const fileRef = storage.ref().child(filePath);
                                    await fileRef.delete();
                                    
                                    console.log(`이미지 삭제 완료: ${filePath}`);
                                    return { success: true, path: filePath };
                                } catch (deleteError) {
                                    console.error(`이미지 삭제 실패: ${imageUrl}`, deleteError);
                                    return { success: false, path: imageUrl, error: deleteError };
                                }
                            });
                            
                            imageDeleteResults = await Promise.all(deletePromises);
                            const successCount = imageDeleteResults.filter(result => result.success).length;
                            const failCount = imageDeleteResults.filter(result => !result.success).length;
                            
                            console.log(`이미지 삭제 결과: 성공 ${successCount}개, 실패 ${failCount}개`);
                        }
                    }

                    // Firestore에서 문의 삭제
                    await db.collection('franchise_inquiries').doc(docId).delete();
                    
                    // 활동 로그 기록
                    await activityLogger.logActivity('delete_inquiry', {
                        inquiryId: docId,
                        adminId: localStorage.getItem('adminId'),
                        imageDeleteResults: imageDeleteResults
                    });

                    alert('삭제되었습니다.');
                    await this.loadInquiries();
                } catch (error) {
                    console.error('문의 삭제 실패:', error);
                    alert('문의 삭제에 실패했습니다.');
                }
            }
        };

        // 로그인 처리
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('adminId').value;
            const pw = document.getElementById('adminPw').value;
            
            try {
                // 임시 로그인 처리 (실제 구현 시 서버 인증 필요)
                if (id === '55555' && pw === '55555') {
                    localStorage.setItem('adminId', id);
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    // 로그인 활동 기록
                    await activityLogger.logActivity('login', { adminId: id });
                    
                    // 데이터 로드
                    await Promise.all([
                        inquiryManager.loadInquiries()
                        // activityLogger.loadActivityLogs() 제거 - 펼치기 시에만 로드
                    ]);
                } else {
                    throw new Error('아이디 또는 비밀번호가 올바르지 않습니다.');
                }
            } catch (error) {
                alert(error.message);
            }
        });

        // 이미지 모달 기능
        function openImageModal(imageUrl, title) {
            const modalHTML = `
                <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-medium">${title}</h3>
                            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="ri-close-line text-xl"></i>
                            </button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto">
                            <img src="${imageUrl}" alt="${title}" class="w-full h-auto max-h-[70vh] object-contain">
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <a href="${imageUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                <i class="ri-external-link-line mr-1"></i>새 탭에서 보기
                            </a>
                            <button onclick="closeImageModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거 후 새 모달 추가
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // 전역 함수로 등록
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;

        // 로그아웃 처리
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const adminId = localStorage.getItem('adminId');
                await activityLogger.logActivity('logout', { adminId });
                
                localStorage.removeItem('adminId');
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        });

        // 상태 필터 변경 이벤트
        document.getElementById('statusFilter').addEventListener('change', () => {
            inquiryManager.loadInquiries();
        });

        // 활동 로그 펼치기/접기 기능
        document.getElementById('toggleActivityLogs').addEventListener('click', async function() {
            const activityLogsContent = document.getElementById('activityLogsContent');
            const buttonText = this.querySelector('span');
            const arrowIcon = this.querySelector('i');
            
            if (activityLogsContent.classList.contains('hidden')) {
                // 펼치기
                activityLogsContent.classList.remove('hidden');
                buttonText.textContent = '접기';
                arrowIcon.classList.remove('ri-arrow-down-s-line');
                arrowIcon.classList.add('ri-arrow-up-s-line');
                
                // 처음 펼칠 때만 데이터 로드
                await activityLogger.expandAndLoad();
            } else {
                // 접기
                activityLogsContent.classList.add('hidden');
                buttonText.textContent = '펼치기';
                arrowIcon.classList.remove('ri-arrow-up-s-line');
                arrowIcon.classList.add('ri-arrow-down-s-line');
                activityLogger.isExpanded = false;
            }
        });

        // 페이지네이션 버튼 이벤트
        document.getElementById('prevActivityPage').addEventListener('click', async function() {
            await activityLogger.prevPage();
        });

        document.getElementById('nextActivityPage').addEventListener('click', async function() {
            await activityLogger.nextPage();
        });

        // 페이지 로드 시 인증 상태 확인
        window.addEventListener('load', async () => {
            try {
                // Firebase 컬렉션 초기화
                await initializeCollections();
                
                const adminId = localStorage.getItem('adminId');
                if (adminId) {
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    await Promise.all([
                        inquiryManager.loadInquiries()
                        // activityLogger.loadActivityLogs() 제거 - 펼치기 시에만 로드
                    ]);
                }
            } catch (error) {
                console.error('초기화 실패:', error);
            }
        });
    </script>
</body>
</html> 