<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¸í¸ìƒíšŒ ê´€ë¦¬ì</title>
    <!-- Tailwind CSS - í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹Œë“œëœ CSS íŒŒì¼ ì‚¬ìš© ê¶Œì¥ -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- CKEditor ì¶”ê°€ -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
    <!-- ì´ë¯¸ì§€ ìµœì í™”ë¥¼ ìœ„í•œ browser-image-compression ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2C3E50',
                        beige: '#F5F0E1',
                        brown: '#D7A86E',
                        yellow: '#F1C40F'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg w-96">
            <h2 class="text-2xl font-bold mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ì•„ì´ë””</label>
                    <input type="text" id="adminId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPw" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90">
                    ë¡œê·¸ì¸
                </button>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div id="dashboard" class="hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-secondary">í¸í¸ìƒíšŒ ê´€ë¦¬ì</span>
                    </div>
                    <div class="flex items-center">
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-900">
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
            <div class="grid grid-cols-3 gap-2 sm:gap-4 md:gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">ê¸ˆì¼ ë¬¸ì˜</h3>
                    <p id="todayInquiries" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">ì´ë²ˆ ë‹¬ ë¬¸ì˜</h3>
                    <p id="monthInquiries" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
                    <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-1 sm:mb-2">ê³„ì•½ ì™„ë£Œ</h3>
                    <p id="completedContracts" class="text-2xl sm:text-3xl md:text-5xl font-bold text-primary">0</p>
                </div>
            </div>

            <!-- íŒŒíŠ¸ë„ˆ ë¬¸ì˜ ê´€ë¦¬ -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">íŒŒíŠ¸ë„ˆ ë¬¸ì˜ ê´€ë¦¬</h2>
                    <div class="flex space-x-2">
                        <select id="statusFilter" class="border rounded-md px-3 py-1">
                            <option value="all">ì „ì²´</option>
                            <option value="pending">ì ‘ìˆ˜ì™„ë£Œ</option>
                            <option value="checking">í™•ì¸ì¤‘</option>
                            <option value="consulting">ìƒë‹´ì¤‘</option>
                            <option value="completed">ìƒë‹´ì™„ë£Œ</option>
                            <option value="canceled">ì·¨ì†Œ</option>
                        </select>
                        <button onclick="inquiryManager.loadInquiries()" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200">
                            <i class="ri-refresh-line"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ì´ë¦„</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ì—°ë½ì²˜</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">í¬ë§ì§€ì—­</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">íŒŒíŠ¸ë„ˆ ìœ í˜•</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="inquiryList" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- í™œë™ ë¡œê·¸ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">í™œë™ ë¡œê·¸</h2>
                    <button id="toggleActivityLogs" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 flex items-center gap-2">
                        <span>í¼ì¹˜ê¸°</span>
                        <i class="ri-arrow-down-s-line"></i>
                    </button>
                </div>
                <div id="activityLogsContent" class="hidden">
                    <!-- ë¡œë”© ìƒíƒœ í‘œì‹œ -->
                    <div id="activityLoading" class="hidden flex items-center justify-center py-8">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                            <span class="text-gray-600">ì¡°íšŒì¤‘...</span>
                        </div>
                    </div>
                    
                    <!-- ë°ì´í„° í…Œì´ë¸” -->
                    <div id="activityTable" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ì‹œê°„</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬ì</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ì‹ ì²­ì</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wider">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="activityList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                    <div id="activityPagination" class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            <span id="activityPageInfo">0-0 / 0ê°œ</span>
                        </div>
                        <div class="flex gap-2">
                            <button id="prevActivityPage" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                ì´ì „
                            </button>
                            <button id="nextActivityPage" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                ë‹¤ìŒ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ì „ì†¡ ëª¨ë‹¬ ìˆ˜ì • -->
    <div id="messageModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-[800px] max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium">ë©”ì‹œì§€ ì‘ì„±</h3>
                <button onclick="messageManager.closeMessageModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="messageEditor"></div>
            </div>
            <div class="p-4 border-t flex justify-end gap-2">
                <button onclick="messageManager.closeMessageModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    ì·¨ì†Œ
                </button>
                <button onclick="messageManager.sendMessage()" 
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                    ì „ì†¡
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCbu_1gbtSIVUvmmw5RyLYvjaYOG7RdCWw",
            authDomain: "ppap-ea44a.firebaseapp.com",
            projectId: "ppap-ea44a",
            storageBucket: "ppap-ea44a.firebasestorage.app",
            messagingSenderId: "811949338329",
            appId: "1:811949338329:web:cda8d43a7aeb825ce258c8",
            measurementId: "G-6QGZT6Y1TE"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase Authentication ê´€ë ¨ ì—ëŸ¬ ë¬´ì‹œ (í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        // Authenticationì´ ì„¤ì •ë˜ì§€ ì•Šì•„ë„ FirestoreëŠ” ì •ìƒ ì‘ë™

        // Firebase ì»¬ë ‰ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
        const initializeCollections = async () => {
            try {
                // franchise_inquiries ì»¬ë ‰ì…˜ì´ ì—†ìœ¼ë©´ ìƒì„±
                const inquiriesSnapshot = await db.collection('franchise_inquiries').get();
                if (inquiriesSnapshot.empty) {
                    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
                    await db.collection('franchise_inquiries').add({
                        name: 'í™ê¸¸ë™',
                        phone: '010-1234-5678',
                        location: 'ì„œìš¸ ê°•ë‚¨êµ¬',
                        partnerType: 'ì „ì† íŒŒíŠ¸ë„ˆ',
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // activity_logs ì»¬ë ‰ì…˜ì´ ì—†ìœ¼ë©´ ìƒì„±
                const logsSnapshot = await db.collection('activity_logs').get();
                if (logsSnapshot.empty) {
                    // ìƒ˜í”Œ ë¡œê·¸ ì¶”ê°€
                    await db.collection('activity_logs').add({
                        action: 'system_init',
                        data: { message: 'ì‹œìŠ¤í…œ ì´ˆê¸°í™”' },
                        adminId: 'system',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                console.log('Firebase ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('Firebase ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                
                // ê¶Œí•œ ì—ëŸ¬ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
                if (error.code === 'permission-denied') {
                    alert('Firebase ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\nFirebase Consoleì—ì„œ Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì„ì‹œ í•´ê²°ì±…:\nrules_version = \'2\';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}');
                }
            }
        };

        // í†µê³„ ê´€ë¦¬ì
        const statsManager = {
            async updateStatistics() {
                try {
                    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • (ì‹œì‘ ì‹œê°„)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // ì´ë²ˆ ë‹¬ ì‹œì‘ì¼ ì„¤ì •
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

                    // ê¸ˆì¼ ë¬¸ì˜ ìˆ˜ ì¡°íšŒ
                    const todayInquiries = await db.collection('franchise_inquiries')
                        .where('createdAt', '>=', today)
                        .get();

                    // ì´ë²ˆ ë‹¬ ë¬¸ì˜ ìˆ˜ ì¡°íšŒ
                    const monthInquiries = await db.collection('franchise_inquiries')
                        .where('createdAt', '>=', monthStart)
                        .get();

                    // ê³„ì•½ ì™„ë£Œ ìˆ˜ ì¡°íšŒ
                    const completedInquiries = await db.collection('franchise_inquiries')
                        .where('status', '==', 'completed')
                        .get();

                    // í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('todayInquiries').textContent = todayInquiries.size;
                    document.getElementById('monthInquiries').textContent = monthInquiries.size;
                    document.getElementById('completedContracts').textContent = completedInquiries.size;
                } catch (error) {
                    console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }
        };

        // í™œë™ ë¡œê·¸ ê´€ë¦¬ì
        const activityLogger = {
            currentPage: 1,
            pageSize: 10,
            totalLogs: 0,
            isExpanded: false,
            allLogs: [],

            showLoading() {
                document.getElementById('activityLoading').classList.remove('hidden');
                document.getElementById('activityTable').classList.add('hidden');
                document.getElementById('activityPagination').classList.add('hidden');
            },

            hideLoading() {
                document.getElementById('activityLoading').classList.add('hidden');
                document.getElementById('activityTable').classList.remove('hidden');
                document.getElementById('activityPagination').classList.remove('hidden');
            },

            async logActivity(action, data) {
                try {
                    await db.collection('activity_logs').add({
                        action,
                        data,
                        adminId: localStorage.getItem('adminId'),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('í™œë™ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
                    // ê¶Œí•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
                    if (error.code !== 'permission-denied') {
                        console.warn('í™œë™ ë¡œê·¸ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error.message);
                    }
                }
            },

            async loadActivityLogs(page = 1) {
                try {
                    this.showLoading();
                    this.currentPage = page;
                    
                    // ëª¨ë“  ë¡œê·¸ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 100ê°œ)
                    const snapshot = await db.collection('activity_logs')
                        .orderBy('timestamp', 'desc')
                        .limit(100)
                        .get();

                    this.allLogs = [];
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        let applicantName = '-';

                        // ë¬¸ì˜ IDê°€ ìˆëŠ” ê²½ìš° ì‹ ì²­ì ì •ë³´ ì¡°íšŒ
                        if (data.data && data.data.inquiryId) {
                            try {
                                const inquiryDoc = await db.collection('franchise_inquiries')
                                    .doc(data.data.inquiryId)
                                    .get();
                                
                                if (inquiryDoc.exists) {
                                    applicantName = inquiryDoc.data().name || '-';
                                }
                            } catch (error) {
                                console.error('ì‹ ì²­ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                            }
                        }

                        this.allLogs.push({
                            id: doc.id,
                            ...data,
                            applicantName
                        });
                    }

                    this.totalLogs = this.allLogs.length;
                    this.displayCurrentPage();
                    this.hideLoading();
                } catch (error) {
                    console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.hideLoading();
                    
                    // ê¶Œí•œ ì—ëŸ¬ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
                    if (error.code === 'permission-denied') {
                        const tbody = document.getElementById('activityList');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                    <div class="mb-4">
                                        <i class="ri-error-warning-line text-4xl text-yellow-500"></i>
                                    </div>
                                    <div class="text-lg font-medium mb-2">Firebase ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                                    <div class="text-sm text-gray-400">
                                        Firebase Consoleì—ì„œ Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                }
            },

            displayCurrentPage() {
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const pageLogs = this.allLogs.slice(startIndex, endIndex);

                const tbody = document.getElementById('activityList');
                tbody.innerHTML = '';

                pageLogs.forEach(log => {
                    const row = `
                        <tr>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">
                                ${new Date(log.timestamp.toDate()).toLocaleString()}
                            </td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${log.adminId}</td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${log.applicantName}</td>
                            <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${this.getActionText(log.action)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
                this.updatePaginationInfo();
            },

            updatePaginationInfo() {
                const startIndex = (this.currentPage - 1) * this.pageSize + 1;
                const endIndex = Math.min(this.currentPage * this.pageSize, this.totalLogs);
                
                document.getElementById('activityPageInfo').textContent = 
                    `${startIndex}-${endIndex} / ${this.totalLogs}ê°œ`;

                // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                const prevBtn = document.getElementById('prevActivityPage');
                const nextBtn = document.getElementById('nextActivityPage');
                
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage * this.pageSize >= this.totalLogs;
            },

            async nextPage() {
                if (this.currentPage * this.pageSize < this.totalLogs) {
                    this.currentPage++;
                    this.displayCurrentPage();
                }
            },

            async prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.displayCurrentPage();
                }
            },

            async expandAndLoad() {
                if (!this.isExpanded) {
                    this.isExpanded = true;
                    await this.loadActivityLogs(1);
                }
            },

            getActionText(action) {
                const actionTexts = {
                    'login': 'ë¡œê·¸ì¸',
                    'logout': 'ë¡œê·¸ì•„ì›ƒ',
                    'update_inquiry_status': 'ë¬¸ì˜ ìƒíƒœ ë³€ê²½',
                    'update_inquiry_memo': 'ìƒë‹´ ë©”ëª¨ ì‘ì„±',
                    'view_inquiry_detail': 'ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ',
                    'delete_inquiry': 'ë¬¸ì˜ ì‚­ì œ',
                    'send_message': 'ë©”ì‹œì§€ ì „ì†¡',
                    'system_init': 'ì‹œìŠ¤í…œ ì´ˆê¸°í™”'
                };
                return actionTexts[action] || action;
            }
        };

        // ì´ë¯¸ì§€ ê´€ë¦¬ì ìˆ˜ì •
        const imageManager = {
            // ì´ë¯¸ì§€ ìµœì í™”
            async optimizeImage(file) {
                try {
                    const options = {
                        maxSizeMB: 0.5,
                        maxWidthOrHeight: 1200,
                        useWebWorker: true,
                        fileType: 'image/jpeg',
                        initialQuality: 0.7
                    };
                    
                    const compressedFile = await imageCompression(file, options);
                    console.log('ì••ì¶• ì „ í¬ê¸°:', file.size / 1024 / 1024, 'MB');
                    console.log('ì••ì¶• í›„ í¬ê¸°:', compressedFile.size / 1024 / 1024, 'MB');
                    return compressedFile;
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ìµœì í™” ì‹¤íŒ¨:', error);
                    throw new Error('ì´ë¯¸ì§€ ìµœì í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },

            // ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                    reader.readAsDataURL(file);
                });
            },

            // Firestoreì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
            async uploadToFirestore(file) {
                try {
                    const optimizedFile = await this.optimizeImage(file);
                    const base64Data = await this.fileToBase64(optimizedFile);
                    
                    // Firestoreì— ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
                    const docRef = await db.collection('inquiry_images').add({
                        data: base64Data,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        type: optimizedFile.type,
                        size: optimizedFile.size
                    });

                    // ì´ë¯¸ì§€ URL ìƒì„± (Base64 ë°ì´í„° ì§ì ‘ ì‚¬ìš©)
                    return base64Data;
                } catch (error) {
                    console.error('Firestore ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        // ë©”ì‹œì§€ ê´€ë¦¬ì ìˆ˜ì •
        const messageManager = {
            currentInquiryId: null,
            editor: null,

            initEditor() {
                if (!this.editor) {
                    ClassicEditor
                        .create(document.querySelector('#messageEditor'), {
                            toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'uploadImage', '|', 'undo', 'redo'],
                            placeholder: 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
                            image: {
                                upload: {
                                    types: ['jpeg', 'png', 'gif', 'bmp', 'webp', 'tiff']
                                }
                            }
                        })
                        .then(editor => {
                            this.editor = editor;

                            // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ ìˆ˜ì •
                            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                                return {
                                    upload: async () => {
                                        try {
                                            const file = await loader.file;
                                            
                                            if (file.size > 5 * 1024 * 1024) {
                                                throw new Error('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                            }

                                            if (!file.type.startsWith('image/')) {
                                                throw new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                                            }

                                            const url = await imageManager.uploadToFirestore(file);
                                            return { default: url };
                                        } catch (error) {
                                            console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                                            throw error;
                                        }
                                    }
                                };
                            };
                        })
                        .catch(error => {
                            console.error('ì—ë””í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                            alert('ì—ë””í„° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        });
                }
            },

            showMessageModal(inquiryId) {
                this.currentInquiryId = inquiryId;
                document.getElementById('messageModal').classList.remove('hidden');
                this.initEditor();
            },

            closeMessageModal() {
                document.getElementById('messageModal').classList.add('hidden');
                this.currentInquiryId = null;
                if (this.editor) {
                    this.editor.setData('');
                }
            },

            async sendMessage() {
                if (!this.currentInquiryId || !this.editor) return;

                try {
                    const content = this.editor.getData();
                    if (!content.trim()) {
                        alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    await db.collection('inquiry_messages').add({
                        inquiryId: this.currentInquiryId,
                        content: content,
                        adminId: localStorage.getItem('adminId'),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // í™œë™ ë¡œê·¸ ê¸°ë¡
                    await activityLogger.logActivity('send_message', {
                        inquiryId: this.currentInquiryId,
                        adminId: localStorage.getItem('adminId')
                    });

                    alert('ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.closeMessageModal();
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                    alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        // ë¬¸ì˜ ê´€ë¦¬ì
        const inquiryManager = {
            getStatusColor(status) {
                const colors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'checking': 'bg-blue-100 text-blue-800',
                    'consulting': 'bg-purple-100 text-purple-800',
                    'completed': 'bg-green-100 text-green-800',
                    'canceled': 'bg-red-100 text-red-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            },

            async loadInquiries() {
                try {
                    let query = db.collection('franchise_inquiries')
                        .orderBy('createdAt', 'desc');
                    
                    const statusFilter = document.getElementById('statusFilter').value;
                    if (statusFilter !== 'all') {
                        query = query.where('status', '==', statusFilter);
                    }

                    const snapshot = await query.get();
                    const tbody = document.getElementById('inquiryList');
                    tbody.innerHTML = '';

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const statusTexts = {
                            'pending': 'ì ‘ìˆ˜ì™„ë£Œ',
                            'checking': 'í™•ì¸ì¤‘',
                            'consulting': 'ìƒë‹´ì¤‘',
                            'completed': 'ìƒë‹´ì™„ë£Œ',
                            'canceled': 'ì·¨ì†Œ'
                        };
                        const row = `
                            <tr>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 rounded text-xs sm:text-sm ${this.getStatusColor(data.status)}">${statusTexts[data.status]}</span>
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">
                                    ${new Date(data.createdAt.toDate()).toLocaleString()}
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base font-medium">${data.name}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.phone}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.location}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-sm sm:text-base">${data.partnerType}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                    <div class="flex space-x-1 sm:space-x-2">
                                        <button onclick="inquiryManager.showDetail('${doc.id}')" 
                                                class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">
                                            ìƒì„¸
                                        </button>
                                        ${data.status === 'consulting' ? `
                                        <button onclick="messageManager.showMessageModal('${doc.id}')"
                                                class="text-green-600 hover:text-green-800 text-sm sm:text-base">
                                            íšŒì‹ 
                                        </button>
                                        ` : ''}
                                        <button onclick="inquiryManager.deleteInquiry('${doc.id}')"
                                                class="text-red-600 hover:text-red-800 text-sm sm:text-base">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                    await statsManager.updateStatistics();
                } catch (error) {
                    console.error('ë¬¸ì˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    
                    // ê¶Œí•œ ì—ëŸ¬ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
                    if (error.code === 'permission-denied') {
                        const tbody = document.getElementById('inquiryList');
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <div class="mb-4">
                                        <i class="ri-error-warning-line text-4xl text-yellow-500"></i>
                                    </div>
                                    <div class="text-lg font-medium mb-2">Firebase ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                                    <div class="text-sm text-gray-400 mb-4">
                                        Firebase Consoleì—ì„œ Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                                    </div>
                                    <div class="bg-gray-100 p-3 rounded text-xs font-mono text-left">
                                        rules_version = '2';<br>
                                        service cloud.firestore {<br>
                                        &nbsp;&nbsp;match /databases/{database}/documents {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;match /{document=**} {<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if true;<br>
                                        &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                                        &nbsp;&nbsp;}<br>
                                        }
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        alert('ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            },

            async showDetail(docId) {
                try {
                    const doc = await db.collection('franchise_inquiries').doc(docId).get();
                    if (!doc.exists) {
                        alert('ë¬¸ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const data = doc.data();
                    const statusTexts = {
                        'pending': 'ì ‘ìˆ˜ì™„ë£Œ',
                        'checking': 'í™•ì¸ì¤‘',
                        'consulting': 'ìƒë‹´ì¤‘',
                        'completed': 'ìƒë‹´ì™„ë£Œ',
                        'canceled': 'ì·¨ì†Œ'
                    };

                    // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìƒì„±
                    const modalHTML = `
                        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-white rounded-lg w-[800px] max-h-[90vh] flex flex-col">
                                <div class="p-4 border-b flex justify-between items-center">
                                    <h3 class="text-lg font-medium">ë¬¸ì˜ ìƒì„¸ ì •ë³´</h3>
                                    <button onclick="inquiryManager.closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                                        <i class="ri-close-line text-xl"></i>
                                    </button>
                                </div>
                                <div class="p-6 flex-1 overflow-y-auto">
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ì‹ ì²­ì ì •ë³´</label>
                                            <div class="space-y-3">
                                                <div>
                                                    <span class="text-sm text-gray-500">ì´ë¦„:</span>
                                                    <span class="ml-2 font-medium">${data.name}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">ì—°ë½ì²˜:</span>
                                                    <span class="ml-2 font-medium">${data.phone}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">í¬ë§ì§€ì—­:</span>
                                                    <span class="ml-2 font-medium">${data.location}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">íŒŒíŠ¸ë„ˆ ìœ í˜•:</span>
                                                    <span class="ml-2 font-medium">${data.partnerType}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ ê´€ë¦¬</label>
                                            <div class="space-y-3">
                                                <div>
                                                    <span class="text-sm text-gray-500">í˜„ì¬ ìƒíƒœ:</span>
                                                    <span class="ml-2 px-2 py-1 rounded text-xs ${this.getStatusColor(data.status)}">${statusTexts[data.status]}</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">ì‹ ì²­ì¼:</span>
                                                    <span class="ml-2 text-sm">${new Date(data.createdAt.toDate()).toLocaleString()}</span>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ ë³€ê²½</label>
                                                    <select id="statusSelect" class="w-full border rounded-md px-3 py-2">
                                                        <option value="pending" ${data.status === 'pending' ? 'selected' : ''}>ì ‘ìˆ˜ì™„ë£Œ</option>
                                                        <option value="checking" ${data.status === 'checking' ? 'selected' : ''}>í™•ì¸ì¤‘</option>
                                                        <option value="consulting" ${data.status === 'consulting' ? 'selected' : ''}>ìƒë‹´ì¤‘</option>
                                                        <option value="completed" ${data.status === 'completed' ? 'selected' : ''}>ìƒë‹´ì™„ë£Œ</option>
                                                        <option value="canceled" ${data.status === 'canceled' ? 'selected' : ''}>ì·¨ì†Œ</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ${data.additionalMessage ? `
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¶”ê°€ ë¬¸ì˜ ì‚¬í•­</label>
                                        <div class="bg-gray-50 p-4 rounded-md">
                                            <p class="text-sm whitespace-pre-wrap">${data.additionalMessage}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    ${data.imageUrls && data.imageUrls.length > 0 ? `
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ì²¨ë¶€ëœ ì´ë¯¸ì§€ (${data.imageUrls.length}/3ê°œ)
                                            <span class="text-xs text-gray-500 ml-2">ğŸ“¸ ìµœì í™”ë¨ (ë†’ì´ 300px ê¸°ì¤€)</span>
                                        </label>
                                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3" id="admin-image-thumbnails">
                                            <!-- ì¸ë„¤ì¼ì€ JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
                                        </div>
                                        <div class="mt-2 text-xs text-gray-500">
                                            ğŸ’¡ ê°€ì´ë“œë¼ì¸: ë§¤ì¥ ì „ê²½ â€¢ ìƒí’ˆ êµ¬ì„± â€¢ ì°¸ê³ ì‚¬í•­
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="p-4 border-t flex justify-end gap-2">
                                    <button onclick="inquiryManager.closeDetailModal()" 
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        ë‹«ê¸°
                                    </button>
                                    <button onclick="inquiryManager.updateStatusFromDetail('${docId}')" 
                                            class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                                        ìƒíƒœ ë³€ê²½
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆ ëª¨ë‹¬ ì¶”ê°€
                    const existingModal = document.getElementById('detailModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    document.body.insertAdjacentHTML('beforeend', modalHTML);

                    // ëª¨ë‹¬ì„ DOMì— ì¶”ê°€í•œ ì§í›„ ì¸ë„¤ì¼ ë™ì  ìƒì„± ì½”ë“œ ì¶”ê°€
                    const container = document.getElementById('admin-image-thumbnails');
                    if (container && Array.isArray(data.imageUrls)) {
                        container.innerHTML = '';
                        data.imageUrls.forEach((url, index) => {
                            const div = document.createElement('div');
                            div.className = 'relative group';
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = `ì²¨ë¶€ ì´ë¯¸ì§€ ${index + 1}`;
                            img.className = 'w-full h-24 object-cover rounded-lg border cursor-pointer hover:opacity-80 transition-opacity';
                            img.addEventListener('click', function() {
                                window.openImageModal(url, `${data.name}ë‹˜ì˜ ì²¨ë¶€ ì´ë¯¸ì§€ ${index + 1}`);
                            });
                            div.appendChild(img);
                            container.appendChild(div);
                        });
                    }

                    // í™œë™ ë¡œê·¸ ê¸°ë¡
                    await activityLogger.logActivity('view_inquiry_detail', {
                        inquiryId: docId
                    });

                } catch (error) {
                    console.error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    alert('ë¬¸ì˜ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },

            closeDetailModal() {
                const modal = document.getElementById('detailModal');
                if (modal) {
                    modal.remove();
                }
            },

            async updateStatusFromDetail(docId) {
                try {
                    const newStatus = document.getElementById('statusSelect').value;
                    
                    // ìƒë‹´ì™„ë£Œë¡œ ë³€ê²½í•˜ëŠ” ê²½ìš° í™•ì¸ ì–¼ëŸ¿ í‘œì‹œ
                    if (newStatus === 'completed') {
                        const confirmMessage = `ìƒë‹´ì™„ë£Œë¡œ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜ì‚¬í•­:\nâ€¢ ì²¨ë¶€ëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì´ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤\nâ€¢ ì‚­ì œëœ ì´ë¯¸ì§€ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\nâ€¢ ìƒë‹´ ì™„ë£Œ í›„ì—ëŠ” ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                        
                        if (!confirm(confirmMessage)) {
                            return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°
                        }
                    }
                    
                    await this.updateStatus(docId, newStatus);
                    this.closeDetailModal();
                } catch (error) {
                    console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    alert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },

            async updateStatus(docId, newStatus) {
                try {
                    // ìƒë‹´ ì™„ë£Œ ì‹œ ì´ë¯¸ì§€ ì‚­ì œ ì²˜ë¦¬
                    if (newStatus === 'completed') {
                        try {
                            // ë¬¸ì˜ ë°ì´í„° ì¡°íšŒ
                            const inquiryDoc = await db.collection('franchise_inquiries').doc(docId).get();
                            if (inquiryDoc.exists) {
                                const inquiryData = inquiryDoc.data();
                                
                                // ì´ë¯¸ì§€ URLì´ ìˆëŠ” ê²½ìš° ì‚­ì œ
                                if (inquiryData.imageUrls && inquiryData.imageUrls.length > 0) {
                                    console.log(`ìƒë‹´ ì™„ë£Œ: ${inquiryData.imageUrls.length}ê°œ ì´ë¯¸ì§€ ì‚­ì œ ì‹œì‘`);
                                    
                                    // Firebase Storageì—ì„œ ì´ë¯¸ì§€ ì‚­ì œ
                                    const deletePromises = inquiryData.imageUrls.map(async (imageUrl) => {
                                        try {
                                            // URLì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
                                            const urlParts = imageUrl.split('/');
                                            const fileName = urlParts[urlParts.length - 1].split('?')[0];
                                            
                                            // ë‚ ì§œë³„ í´ë” êµ¬ì¡°ì—ì„œ íŒŒì¼ ì°¾ê¸°
                                            const dateStr = inquiryData.createdAt.toDate().toISOString().split('T')[0];
                                            const filePath = `franchise_inquiries/${dateStr}/${fileName}`;
                                            
                                            const fileRef = storage.ref().child(filePath);
                                            await fileRef.delete();
                                            
                                            console.log(`ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ: ${filePath}`);
                                            return { success: true, path: filePath };
                                        } catch (deleteError) {
                                            console.error(`ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ${imageUrl}`, deleteError);
                                            return { success: false, path: imageUrl, error: deleteError };
                                        }
                                    });
                                    
                                    const deleteResults = await Promise.all(deletePromises);
                                    const successCount = deleteResults.filter(result => result.success).length;
                                    const failCount = deleteResults.filter(result => !result.success).length;
                                    
                                    console.log(`ì´ë¯¸ì§€ ì‚­ì œ ê²°ê³¼: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`);
                                    
                                    // ì‚­ì œ ê²°ê³¼ë¥¼ í™œë™ ë¡œê·¸ì— ê¸°ë¡
                                    await activityLogger.logActivity('delete_images_on_completion', {
                                        inquiryId: docId,
                                        totalImages: inquiryData.imageUrls.length,
                                        deletedCount: successCount,
                                        failedCount: failCount,
                                        failedUrls: deleteResults.filter(result => !result.success).map(result => result.path)
                                    });
                                    
                                    if (failCount > 0) {
                                        console.warn(`${failCount}ê°œ ì´ë¯¸ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                                    }
                                }
                            }
                        } catch (imageDeleteError) {
                            console.error('ì´ë¯¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', imageDeleteError);
                            // ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨í•´ë„ ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ê³„ì† ì§„í–‰
                        }
                    }

                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    await db.collection('franchise_inquiries').doc(docId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // í™œë™ ë¡œê·¸ ê¸°ë¡
                    await activityLogger.logActivity('update_inquiry_status', {
                        inquiryId: docId,
                        newStatus: newStatus
                    });

                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await this.loadInquiries();
                    
                    // ìƒë‹´ ì™„ë£Œ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                    if (newStatus === 'completed') {
                        alert('ìƒë‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì²¨ë¶€ëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì´ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    alert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },

            async deleteInquiry(docId) {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì²¨ë¶€ëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
                    return;
                }

                try {
                    // ë¬¸ì˜ ë°ì´í„° ì¡°íšŒ (ì´ë¯¸ì§€ ì‚­ì œë¥¼ ìœ„í•´)
                    const inquiryDoc = await db.collection('franchise_inquiries').doc(docId).get();
                    let imageDeleteResults = [];
                    
                    if (inquiryDoc.exists) {
                        const inquiryData = inquiryDoc.data();
                        
                        // ì´ë¯¸ì§€ URLì´ ìˆëŠ” ê²½ìš° ì‚­ì œ
                        if (inquiryData.imageUrls && inquiryData.imageUrls.length > 0) {
                            console.log(`ë¬¸ì˜ ì‚­ì œ: ${inquiryData.imageUrls.length}ê°œ ì´ë¯¸ì§€ ì‚­ì œ ì‹œì‘`);
                            
                            // Firebase Storageì—ì„œ ì´ë¯¸ì§€ ì‚­ì œ
                            const deletePromises = inquiryData.imageUrls.map(async (imageUrl) => {
                                try {
                                    // URLì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
                                    const urlParts = imageUrl.split('/');
                                    const fileName = urlParts[urlParts.length - 1].split('?')[0];
                                    
                                    // ë‚ ì§œë³„ í´ë” êµ¬ì¡°ì—ì„œ íŒŒì¼ ì°¾ê¸°
                                    const dateStr = inquiryData.createdAt.toDate().toISOString().split('T')[0];
                                    const filePath = `franchise_inquiries/${dateStr}/${fileName}`;
                                    
                                    const fileRef = storage.ref().child(filePath);
                                    await fileRef.delete();
                                    
                                    console.log(`ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ: ${filePath}`);
                                    return { success: true, path: filePath };
                                } catch (deleteError) {
                                    console.error(`ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ${imageUrl}`, deleteError);
                                    return { success: false, path: imageUrl, error: deleteError };
                                }
                            });
                            
                            imageDeleteResults = await Promise.all(deletePromises);
                            const successCount = imageDeleteResults.filter(result => result.success).length;
                            const failCount = imageDeleteResults.filter(result => !result.success).length;
                            
                            console.log(`ì´ë¯¸ì§€ ì‚­ì œ ê²°ê³¼: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`);
                        }
                    }

                    // Firestoreì—ì„œ ë¬¸ì˜ ì‚­ì œ
                    await db.collection('franchise_inquiries').doc(docId).delete();
                    
                    // í™œë™ ë¡œê·¸ ê¸°ë¡
                    await activityLogger.logActivity('delete_inquiry', {
                        inquiryId: docId,
                        adminId: localStorage.getItem('adminId'),
                        imageDeleteResults: imageDeleteResults
                    });

                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await this.loadInquiries();
                } catch (error) {
                    console.error('ë¬¸ì˜ ì‚­ì œ ì‹¤íŒ¨:', error);
                    alert('ë¬¸ì˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('adminId').value;
            const pw = document.getElementById('adminPw').value;
            
            try {
                // ì„ì‹œ ë¡œê·¸ì¸ ì²˜ë¦¬ (ì‹¤ì œ êµ¬í˜„ ì‹œ ì„œë²„ ì¸ì¦ í•„ìš”)
                if (id === '55555' && pw === '55555') {
                    localStorage.setItem('adminId', id);
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    // ë¡œê·¸ì¸ í™œë™ ê¸°ë¡
                    await activityLogger.logActivity('login', { adminId: id });
                    
                    // ë°ì´í„° ë¡œë“œ
                    await Promise.all([
                        inquiryManager.loadInquiries()
                        // activityLogger.loadActivityLogs() ì œê±° - í¼ì¹˜ê¸° ì‹œì—ë§Œ ë¡œë“œ
                    ]);
                } else {
                    throw new Error('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert(error.message);
            }
        });

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ê¸°ëŠ¥
        function openImageModal(imageUrl, title) {
            const modalHTML = `
                <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-medium">${title}</h3>
                            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="ri-close-line text-xl"></i>
                            </button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto">
                            <img src="${imageUrl}" alt="${title}" class="w-full h-auto max-h-[70vh] object-contain">
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <a href="${imageUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                <i class="ri-external-link-line mr-1"></i>ìƒˆ íƒ­ì—ì„œ ë³´ê¸°
                            </a>
                            <button onclick="closeImageModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆ ëª¨ë‹¬ ì¶”ê°€
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const adminId = localStorage.getItem('adminId');
                await activityLogger.logActivity('logout', { adminId });
                
                localStorage.removeItem('adminId');
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        });

        // ìƒíƒœ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('statusFilter').addEventListener('change', () => {
            inquiryManager.loadInquiries();
        });

        // í™œë™ ë¡œê·¸ í¼ì¹˜ê¸°/ì ‘ê¸° ê¸°ëŠ¥
        document.getElementById('toggleActivityLogs').addEventListener('click', async function() {
            const activityLogsContent = document.getElementById('activityLogsContent');
            const buttonText = this.querySelector('span');
            const arrowIcon = this.querySelector('i');
            
            if (activityLogsContent.classList.contains('hidden')) {
                // í¼ì¹˜ê¸°
                activityLogsContent.classList.remove('hidden');
                buttonText.textContent = 'ì ‘ê¸°';
                arrowIcon.classList.remove('ri-arrow-down-s-line');
                arrowIcon.classList.add('ri-arrow-up-s-line');
                
                // ì²˜ìŒ í¼ì¹  ë•Œë§Œ ë°ì´í„° ë¡œë“œ
                await activityLogger.expandAndLoad();
            } else {
                // ì ‘ê¸°
                activityLogsContent.classList.add('hidden');
                buttonText.textContent = 'í¼ì¹˜ê¸°';
                arrowIcon.classList.remove('ri-arrow-up-s-line');
                arrowIcon.classList.add('ri-arrow-down-s-line');
                activityLogger.isExpanded = false;
            }
        });

        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('prevActivityPage').addEventListener('click', async function() {
            await activityLogger.prevPage();
        });

        document.getElementById('nextActivityPage').addEventListener('click', async function() {
            await activityLogger.nextPage();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
        window.addEventListener('load', async () => {
            try {
                // Firebase ì»¬ë ‰ì…˜ ì´ˆê¸°í™”
                await initializeCollections();
                
                const adminId = localStorage.getItem('adminId');
                if (adminId) {
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    await Promise.all([
                        inquiryManager.loadInquiries()
                        // activityLogger.loadActivityLogs() ì œê±° - í¼ì¹˜ê¸° ì‹œì—ë§Œ ë¡œë“œ
                    ]);
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        });
    </script>
</body>
</html> 